name: Build docker image
description: Build docker image for a given Ruby version, architecture and libc
inputs:
  ruby-version:
    description: Ruby version
    required: true

  arch:
    description: Build architecture
    required: true

  libc:
    description: Which libc is used
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ inputs.arch }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image
      uses: docker/build-push-action@v6
      with:
        file: .github/actions/docker-build-ruby/Dockerfile${{ inputs.libc == 'musl' && '.alpine' || '' }}
        build-args: |
          "RUBY_VERSION=${{ inputs.ruby-version }}"
        push: false
        load: true
        tags: libddwaf-rb-test:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/${{ inputs.arch }}
